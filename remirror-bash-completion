# bash completion for remirror        -*- shell-script -*-

_mylistselector()
{
    local cur="$1"
    local list_elems_all="$2"

    local realcur="${cur##*,}"
    local prefix="${cur%$realcur}"
    local elems word

    for word in $list_elems_all
    do
        if ! [[ $prefix == *"$word"* ]]; then
            elems="$word $elems"
        fi
    done
    COMPREPLY=( $(compgen -P "$prefix" -W "$elems" -S ',' -- $realcur) )
    compopt -o nospace
}

_mycountryselector()
{
    local cur="$1"
    local countries

    if [ 0 -eq 1 ] ; then
        local arch_countries antergos_countries

        # Antergos countries:
        # (removed dups: Bulgaria Canada China Denmark France Germany Greece Hungary
        #                Japan Netherlands Portugal Russia Spain Sweden)
        antergos_countries=(
            'Automated Mirror Selection'
            'Czech Republic' England USA
        )

        # Arch countries, in addition to above:
        arch_countries+=(
            Worldwide
            Australia Austria Bangladesh Belarus Belgium
            'Bosnia and Herzegovina' Brazil Bulgaria Canada Chile
            China Colombia Croatia Czechia Denmark Ecuador Finland
            France Germany Greece 'Hong Kong' Hungary Iceland India
            Indonesia Iran Ireland Israel Italy Japan Kazakhstan
            Latvia Lithuania Luxembourg Macedonia Mexico Netherlands
            'New Caledonia' 'New Zealand' Norway Philippines Poland
            Portugal Qatar Romania Russia Serbia Singapore Slovakia
            Slovenia 'South Africa' 'South Korea' Spain Sweden Switzerland
            Taiwan Thailand Turkey Ukraine 'United Kingdom' 'United States'
            Vietnam
        )
    fi

    local countries_string
    local country
    local osfile=/tmp/remirror-os.tmp
    local os
    if [ -r $osfile ] ; then
        os=$(cat $osfile)
    fi

    case "$os" in
        Antergos)
            countries=(
                'Automated Mirror Selection'
                Bulgaria Canada China 'Czech Republic' Denmark England
                France Germany Greece Hungary
                Japan Netherlands Portugal Russia Spain Sweden USA
            )
            ;;
        Arch)
            countries=(
                Worldwide
                Australia Austria Bangladesh Belarus Belgium
                'Bosnia and Herzegovina' Brazil Bulgaria Canada Chile
                China Colombia Croatia Czechia Denmark Ecuador Finland
                France Germany Greece 'Hong Kong' Hungary Iceland India
                Indonesia Iran Ireland Israel Italy Japan Kazakhstan
                Latvia Lithuania Luxembourg Macedonia Mexico Netherlands
                'New Caledonia' 'New Zealand' Norway Philippines Poland
                Portugal Qatar Romania Russia Serbia Singapore Slovakia
                Slovenia 'South Africa' 'South Korea' Spain Sweden Switzerland
                Taiwan Thailand Turkey Ukraine 'United Kingdom' 'United States'
                Vietnam
            )
            ;;
        *)
            printf "\n os = unknown!\n" >&2
            COMPREPLY=()
            ;;
    esac

    for country in "${countries[@]}"
    do
        if [ "$countries_string" = "" ] ; then
            countries_string="${country// /_}"
        else
            countries_string+=" ${country// /_}"
        fi
    done

    _mylistselector "$cur" "$countries_string"

}

_remirror() 
{
    local cur prev #words cword split
    _init_completion -s || return

    local osfile=/tmp/remirror-os.tmp
    if [ ! -e $osfile ] ; then
        echo "Antergos" > $osfile  # default, but may cause issues...
    fi

    case "$prev" in
        -h|--help|--of|--quiet|--debug)
            return
            ;;
        --c)
            _mycountryselector "$cur"
            return
            ;;
        --os)
            _mylistselector "$cur" "Antergos Arch"
            if [ -n "$COMPREPLY" ] ; then
                echo "${COMPREPLY[0]}" > $osfile
            fi
            return
            ;;
        --p)
            _mylistselector "$cur" "https http"
            return
            ;;
        --tm|--tr)
            COMPREPLY+=( $(compgen -P "$cur" -W "{0..9}") )
            compopt -o nospace
            return
            ;;
        *)
            ;;
    esac

    local opts="--os= --c= --p= --tm= --tr="
    opts+=" --quiet --help -h  --of --debug"

    case "$cur" in
        -*|"")
            COMPREPLY=( $(compgen -W "${opts}" -- ${cur}) )
            compopt -o nospace
            return
            ;;
        *)
            ;;
    esac

} &&
complete -F _remirror remirror
